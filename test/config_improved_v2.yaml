# Improved Configuration with Few-Shot Example Prompt Template
# Version 2: Maximum accuracy with example-based learning

# --- NCBI API Configuration ---
api_key: "85d0ce407d2e5428e18a1d021579bc25d408"
ncbi_api_key: ""
output_dir: "./results_improved_v2"

# --- Variant Source ---
variants_json_file: "./variants.json"

# --- Ollama Model Configuration ---
ollama_model: "llama3.3:70b"
ollama_overwrite: false
run_inference: true

# --- ACMG Criteria Questions ---
questions:
  # Functional Studies
  PS3: "Does this article test the variant--known as {comma-separated_variant_terms}--through in vitro and/or in vivo studies, and if so, did the study show a functional impact of the variant on the gene product?"
  BS3: "Does this article provide well-established functional studies showing the variant--known as {comma-separated_variant_terms}--has no damaging effect on protein function?"
  
  # Population Data  
  PS4: "Does this article demonstrate that the prevalence of the variant--known as {comma-separated_variant_terms}--is significantly increased in affected individuals compared to controls?"
  PM2: "Does this article indicate that the variant--known as {comma-separated_variant_terms}--is absent from controls or extremely rare in population databases?"
  BA1: "Does this article report that the variant--known as {comma-separated_variant_terms}--has an allele frequency >5% in population databases?"
  
  # Protein Structure/Function
  PM1: "Does this article demonstrate that the variant--known as {comma-separated_variant_terms}--is located in a critical and well-established functional domain?"
  PM5: "Does this article report a different missense variant at the exact same amino acid position as {comma-separated_variant_terms} that has been established as pathogenic?"
  
  # Segregation Analysis
  PP1: "Does this article demonstrate co-segregation of the variant--known as {comma-separated_variant_terms}--with disease in multiple affected family members?"
  BS4: "Does this article show lack of segregation of the variant--known as {comma-separated_variant_terms}--with disease in affected family members?"
  
  # Computational Predictions
  PP3: "Does this article provide multiple lines of computational evidence suggesting that the variant--known as {comma-separated_variant_terms}--has a deleterious effect?"
  BP4: "Does this article provide multiple lines of computational evidence suggesting that the variant--known as {comma-separated_variant_terms}--is benign?"

# --- Few-Shot Example Prompt Template for Maximum Accuracy ---
prompt_base_template: |
  You are an expert clinical geneticist and a scientific literature analysis AI. Your task is to analyze a scientific manuscript to determine if it contains evidence supporting a specific ACMG criterion for a genetic variant.
  
  Follow these steps precisely:
  1. **Analyze the Question:** Carefully read the user's question to understand the exact type of evidence required.
  2. **Scan the Manuscript:** Read the provided manuscript, looking for relevant keywords, methods, and results.
  3. **Extract Evidence:** Identify and extract direct quotes from the manuscript that support your final answer.
  4. **Reason and Decide:** Based ONLY on the extracted evidence, formulate a step-by-step reasoning process.
  5. **Provide the Final Answer:** Conclude with a "Yes", "No", or "Unclear" determination.
  
  Your final output MUST be a JSON object. Do not output any text outside of the JSON structure.
  
  --- EXAMPLE ---
  Manuscript:
  ...To assess the functional consequences of the GENEX p.Arg123Trp mutation, we performed an in vitro kinase assay. The results showed that the mutant GENEX protein had only 10% of the kinase activity compared to the wild-type protein (Fig. 3A). This loss of function was statistically significant (p < 0.01). Furthermore, expression of p.Arg123Trp in cell lines resulted in a 5-fold increase in apoptosis compared to controls...
  
  Question: Does this article test the variant--known as "GENEX p.Arg123Trp"--through in vitro and/or in vivo studies, and if so, did the study show a functional impact of the variant on the gene product?
  {
    "answer": "Yes",
    "reason": "The manuscript describes an in vitro kinase assay and cell line expression experiments. The results from the kinase assay showed a 90% reduction in activity, and the cell line study showed increased apoptosis, both indicating a significant functional impact.",
    "evidence_quotes": [
      "To assess the functional consequences of the GENEX p.Arg123Trp mutation, we performed an in vitro kinase assay.",
      "The results showed that the mutant GENEX protein had only 10% of the kinase activity compared to the wild-type protein (Fig. 3A).",
      "expression of p.Arg123Trp in cell lines resulted in a 5-fold increase in apoptosis compared to controls"
    ]
  }
  --- END EXAMPLE ---
  
  --- YOUR TASK ---
  Manuscript:
  """
  {FILENAME}
  """
  
  Question: {question_from_question_list}
  
  {format_instructions}

# --- LangChain Settings for Maximum Accuracy ---
langchain_settings:
  temperature: 0.005         # Ultra-low for maximum determinism
  top_p: 0.8                # Even tighter nucleus sampling
  top_k: 30                 # More restricted token choices
  repeat_penalty: 1.2       # Strong repetition penalty
  max_manuscript_length: 250000  # Max characters per article
  stop_tokens:
    - "\n\n"
    - "```\n"
    - "}\n"
    - "<|im_end|>"
    - "<|eot_id|>"
  num_retries: 7            # More retries for complex analyses
  max_tokens: 1000          # Extra space for evidence quotes
  seed: 42                  # Fixed seed for reproducibility

# --- Performance Configuration ---
max_workers: 1              # Single worker for 70B model stability
efetch_chunk_size_pmc: 20   # Smaller chunks for detailed analysis
efetch_chunk_size_pubmed: 40
api_request_delay: 0.25     # Slightly higher delay for stability

# --- Cache Settings ---
cache_settings:
  enabled: true
  directory: "./cache"
  ttl_days: 30

# --- Output Settings ---
output_settings:
  include_evidence_quotes: true
  format: "all"
  include_timestamps: true
  save_raw_responses: true  # For debugging

# --- Advanced Analysis Settings ---
analysis_settings:
  require_evidence: true    # Must provide quotes
  min_evidence_quotes: 1    # At least one quote required
  max_evidence_quotes: 5    # Cap to prevent excessive output
  confidence_threshold: 0.8 # For future confidence scoring

# --- Logging ---
logging:
  level: "DEBUG"           # Detailed logging for analysis
  format: "%(asctime)s - %(levelname)s - %(message)s"
  file: "analysis_improved_v2.log"
  
# --- Validation Rules ---
validation:
  require_json_output: true
  validate_evidence_quotes: true
  check_answer_consistency: true